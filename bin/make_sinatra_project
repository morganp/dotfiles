#!/usr/bin/env ruby
## Setting up files for a new Bundler/RVM Ruby project
## $ make_sinatra_project some_new_project 
##
## This could be cleaner split into multiple files and seperate templates
## But a single file in the your bin directory is easier to manage
##
## Copyright (C) 2011 Morgan Prior
##    This program is distributed in the hope that it will be useful,
##    but WITHOUT ANY WARRANTY; without even the implied warranty of
##    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##    GNU General Public License for more details.
##    [http://www.gnu.org/licenses/gpl.txt]

require 'FileUtils'

if ARGV.size < 1
  puts "Usage $ make_sinatra_project new_project"
  exit
end

#Command line parse
project_name = (ARGV.first.to_s).dup

#Add CamelCase method to singleton
module CaseFunctions
  def camelcase
    a = self.split /[-|\s| |_|\.]/ #Word Boundry or _
    a = a.map do |word|
      #[0..0] is ruby 1.8.7 safe [0] returns char code 1.8 and char in 1.9
      word[0..0].upcase + word[1..-1]
    end
      
    return a.join('')
  end
end
project_name.extend(CaseFunctions)

puts "Setting up new Project : " +  project_name.camelcase

## TODO
## Get some enviroment variables
## Users default Ruby version 1.8.7 or 1.9.2 (from RVM?)


#if folder does not contain project name make a new directory
current_folder = File.basename( Dir.getwd )
unless ((current_folder == project_name) or (current_folder == project_name.camelcase))
  if File.directory?( project_name )
    puts "Working in #{File.expand_path( project_name)}"
    Dir.chdir( project_name )

  elsif File.directory?( project_name.camelcase )
    puts "Working in #{File.expand_path( project_name.camelcase ) }"
    Dir.chdir( project_name.camelcase )
  
  else
    FileUtils.mkdir_p project_name
    Dir.chdir( project_name )
  end
end


## Template Files
## 
readme_contents = %{
#{project_name.camelcase}
#{'=' * project_name.camelcase.size}

EXAMPLES
========

}

dot_rvmrc_contents = %{
  rvm_gemset_create_on_use_flag=1
  rvm 1.9.2@#{project_name}
}


gemfile_contents = %{
source :rubygems
#If this is a gem 
#Normal gems go in #{project_name}.gemspec
#gemspec
#gem "heroku", "~>2"
gem "sinatra", "~>1" 
gem "activerecord", "~>3" 
gem "sinatra-session", "~>1"
gem "sinatra-flash", "~> 0.3"

#development and test not install on heroku deployment
group :development do
  gem "sinatra-reloader", "~>0"
  gem "sqlite3-ruby", "~>1"
  gem "thin", "~>1"
end

group :test do
  gem "rspec", :require => "spec"
end
}


rakefile_contents = %{
require 'rspec/core/rake_task'

file_list = FileList['spec/*_spec.rb']

RSpec::Core::RakeTask.new('spec') do |t|
  t.pattern = file_list
  t.rspec_opts = ["--colour", "--format progress"]
end

#Rake file for migrations

require 'rubygems'
require 'rake'
require 'active_record'
require 'logger'

namespace :db do
  desc "Migrate the database through scripts in db/migrate. Target specific version with VERSION=x"
  task :migrate => :environment do
    ActiveRecord::Migrator.migrate('db/migrate', ENV["VERSION"] ? ENV["VERSION"].to_i : nil )
  end

  desc "Migrate the database through scripts in db/migrate. DEVELOPMENT Mode"
  task :migrate_devel => :environment_devel do
    ActiveRecord::Migrator.migrate('db/migrate', ENV["VERSION"] ? ENV["VERSION"].to_i : nil )
  end
end

task :environment_devel do
  ActiveRecord::Base.establish_connection(
    :adapter => 'sqlite3',
    :database => 'db/devel.db'
  )
  ActiveRecord::Base.logger = Logger.new(File.open('database.log', 'a'))
end

task :environment do

  ## db = "postgres://username:password@hostname/database"
  db = ENV["DATABASE_URL"]
  db ||= ''
  if db.match(/postgres:\\\/\\\/(.*):(.*)@(.*)\\\/(.*)/) 
    username = $1
    password = $2
    hostname = $3
    database = $4

    ActiveRecord::Base.establish_connection(
      :adapter  => 'postgresql',
      :host     => hostname,
      :username => username,
      :password => password,
      :database => database
    )
  end
end


desc 'Default: run specs.'
task :default => 'spec'
}


top_level_contents = %{
require 'rubygems'
require 'sinatra/base'
#require 'sinatra/session'
#require 'sinatra/flash'

Dir[File.dirname(__FILE__) + '/lib/models/*.rb'].each {|file| require file }


require 'active_record'


module #{project_name.camelcase}
  VERSION = '0.0.1'
  
  class App < Sinatra::Base
    #register Sinatra::Session
    use Rack::MethodOverride
    set :public, "public"
    
    ## Flash messages
    #enable :sessions
    #register Sinatra::Flash
    
    $site_config = {}    

    #Configure Modules ran when starting/restarting Server
    configure :development do
      require "sinatra/reloader"
      
      puts "Development"
      register Sinatra::Reloader
      also_reload "models/*.rb"
      also_reload "helpers/*.rb"

      ActiveRecord::Base.establish_connection(
        :adapter   => 'sqlite3',
        :database  => './db/devel.db'
      )
    end

    configure :test do
      puts "Test"
    end

    configure :production do
      $site_config[:analytics_ena] = true
      db = ENV["DATABASE_URL"]
      db ||= '' # Making it safe ofr non heroku deployment
      if db.match(/postgres:\\\/\\\/(.*):(.*)@(.*)\\\/(.*)/) 
        username = $1
        password = $2
        hostname = $3
        database = $4

        ActiveRecord::Base.establish_connection(
          :adapter  => 'postgresql',
          :host     => hostname,
          :username => username,
          :password => password,
          :database => database
        )
      end
    end


    #Ran on Server Error
    error do
      e = request.env['sinatra.error']
      puts e.to_s
      puts e.backtrace.join("\n")
      "Application error"
    end

    #Some session setup
    set :session_fail, '/login'


    get '/' do
      'HelloWorld!'
    end
  end
end
if $0 == __FILE__
 #{project_name.camelcase}::App.run!
end

}


spec_helper_contents = %{
$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'rspec'
require '#{project_name}'
}

#Add empty test
first_spec_contents = %{
require 'spec_helper'

describe #{project_name} do
  it "should do something" do
    test = #{project_name}::Erm.new()
    test.contents.should == nil
  end
end

}

config_ru_contents = %{
require 'rubygems'
require './lib/app'

run #{project_name.camelcase}::App
}

gemspec_contents = %{
# -*- encoding: utf-8 -*-
$:.push File.expand_path("../lib")
require '#{project_name}'

Gem::Specification.new do |s|
  s.name        = '#{project_name}'
  s.version     = #{project_name.camelcase}::VERSION
  s.platform    = Gem::Platform::RUBY
  s.authors     = ["TODO: Write your name"]
  s.email       = ["TODO: Write your email address"]
  s.homepage    = ""
  s.summary     = %q{#{project_name} TODO: Write a gem summary}
  s.description = %q{#{project_name} TODO: Write a gem description}

  s.files         = `git ls-files`.split("\n")
  s.test_files    = `git ls-files -- {test,spec,features}/*`.split("\n")
  s.executables   = `git ls-files -- bin/*`.split("\n").map{ |f| File.basename(f) }
  s.require_paths = ["lib"]

  #s.add_dependency('some_gem', '>= 1.0.0')
end
}




layout_contents =%{
<!DOCTYPE html>
<html dir="ltr" lang="en-US">
  <%=@pre_head ||= ""%>
  <head>
  <meta charset=utf-8> <!-- simplified version; works on legacy browsers -->
      <title> <%=@title%> </title>
   </head>
   <body id='<%=@body_id%>' class='<%=@body_class%>' > 

<%= yield %>

<% if $site_config[:analytics_ena] %>
   <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA_CODE_HERE']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
  })();

  </script>
<% end %>

  </body>
</html>

  }
# Create File if it does not exist and write the contents
def write( filename, contents, warning='')
  if File.exists? filename
    puts "#{filename} already exists"
  else
    puts warning unless warning == ''
    puts "Creating #{filename}"
    ::File.open( filename, "w" ){ |f| f.write contents }
  end
end


## Create ./spec ./bin ./lib
FileUtils.mkdir_p "spec"
FileUtils.mkdir_p "bin"
FileUtils.mkdir_p File.join( 'lib', 'db', 'migrate') 
FileUtils.mkdir_p File.join( 'lib', 'views')
FileUtils.mkdir_p File.join( 'lib', 'models')
FileUtils.mkdir_p File.join( 'lib', 'public', 'img') 
FileUtils.mkdir_p File.join( 'lib', 'public', 'scripts') 
FileUtils.mkdir_p File.join( 'lib', 'public', 'stylesheets') 


write ".rvmrc",                                             dot_rvmrc_contents 
write "Gemfile",                                            gemfile_contents 
write "Rakefile",                                           rakefile_contents 
write "README.md",                                          readme_contents 
write "config.ru",                                          config_ru_contents 
write "#{project_name.camelcase}.gemspec",                            gemspec_contents
write File.join('lib', 'app.rb'),               top_level_contents 

#Migration 1
#Models



write File.join('spec', 'spec_helper.rb'),                  spec_helper_contents
write File.join('spec', project_name + '_spec.rb'),         first_spec_contents


license_warn= %{WARNING attempting to add the GPL3 License
If you do not want this applied to your project please remove ./LICENSE}

puts "Connecting to gnu.org to retrieve the GPL License"
require 'open-uri'
license_content = ""
open( "http://www.gnu.org/licenses/gpl.txt" ) { |s| license_content = s.read }
write "LICENSE",                                            license_content, license_warn
